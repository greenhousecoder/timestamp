/**
 * Copyright (c) 2010-12 ClementineJS

 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:

 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

function noop(){}function clone(e){var t,n=e instanceof Array?[]:{};for(t in e){if(t==="clone")continue;e[t]&&e[t]instanceof Date?n[t]=new Date(e[t]):e[t]&&typeof e[t]=="object"?n[t]=clone(e[t]):n[t]=e[t]}return n}function proxy(e,t){var n=t;return function(){return e.apply(n,arguments)}}typeof console=="undefined"&&(console={log:function(){},dir:function(){}}),jQuery.fn.childrenTo=function(e){var t=[],n=this;return this.find(e).each(function(){var e=!1,r=$(this).parent();while(r.length!==0&&!e){if($(r).not($(n)).length===0){e=!0;break}if($(r).not("[data-control]").length===0){e=!1;break}r=$(r).parent()}e&&t.push($(this))}),t},jQuery.fn.outerHTML=function(e){return e?this.before(e).remove():jQuery("<p>").append(this.eq(0).clone()).html()},String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},function(){var e,t,n,r,i,s={},o=/[^A-Za-z:0-9_\[\]]/g,u=/[^A-Za-z\-_]/g;t=function(){function n(){}var e=!1,t=/\b_super\b/;return n.extend=function(r){function u(){!e&&this.initialize&&this.initialize.apply(this,arguments)}var i,s,o=this.prototype;e=!0,i=new this,e=!1;for(s in r)i[s]=typeof r[s]=="function"&&typeof o[s]=="function"&&t.test(r[s])?function(e,t){return function(){var n=this._super;this._super=o[e];var r=t.apply(this,arguments);return this._super=n,r}}(s,r[s]):r[s];return u.prototype=i,u.prototype.constructor=u,u.extend=n.extend,u.include=n.include,u},n.include=function(e){var t,n,r;if(!e)throw"Missing definition";for(t in e)n=e[t],Array.prototype.indexOf.call(["extend","include"],t)<0&&(this.prototype[t]=n);return this},n}(),r=function(){function e(e,t,n,r){this.bubbles=!0,this.currentTarget=t,this.data=r,this.target=n,this.type=e}return e.prototype.stopPropagation=function(){this.bubbles=!1},e}(),i=function(){function e(e,t,n){this.call=n,this.ev=t,this.target=e}return e.prototype.detach=function(){this.target.detach(this.ev,this.call),delete this.target,delete this.ev,delete this.call},e}(),n={on:function(e,t,n){var r=typeof n!="undefined"?proxy(t,n):t;return this._listeners||(this._listeners={}),this._listeners.hasOwnProperty(e)||(this._listeners[e]=[]),this._listeners[e].push(r),new i(this,e,r)},once:function(e,t,n){var r=typeof n!="undefined"?proxy(t,n):t,i=function(){t.apply(this,arguments),this.detach(e,r)};this.on(e,i)},fire:function(e,t){var n=this._parent||null,i=e;typeof e=="string"&&(e=new r(e,this,this,t));if(typeof e.type!="string")throw"Error: Invalid 'type' when firing event";this._listeners||(this._listeners={});if(this._listeners[e.type]instanceof Array){var s=this._listeners[e.type];for(var o=0,u=s.length;o<u;o++)s[o].call(this,e,t)}var a=!1;if(this._ignoreEvents instanceof Array)for(var o=0;o<this._ignoreEvents.length;o++)this._ignoreEvents[o]===i&&(a=!0);n!=null&&!a&&e.bubbles&&i[0]!=="_"&&(e.currentTarget=this._parent,n.fire.call(n,e,t))},detach:function(e,t){var n=[];this._listeners||(this._listeners={});if(typeof e=="undefined")this._listeners={};else if(this._listeners[e]instanceof Array)if(typeof t!="undefined"){n=this._listeners[e];for(var r=0,i=n.length;r<i;r++)if(n[r]===t){n.splice(r,1);break}}else this._listeners[e]=[]}},e={touch:"ontouchstart"in window||window.hasOwnProperty("DocumentTouch")&&document instanceof DocumentTouch,location:"geolocation"in navigator},s=this.Clementine={modules:{}},s.version="0.5.0",s.Browser=e=e,s.Class=this.Class=t,s.Events=this.Events=n,s.EventHandle=i}.call(this),Array.prototype.clone=function(){return this.slice(0)},Array.prototype.indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},Array.prototype.first=[].first||function(){return this.length?this[0]:null},Array.prototype.last=[].last||function(){return this.length?this[this.length-1]:null},function(e){function o(e,t){t=$(t).eq(0),e=$(e).get(0);for(var n=0;n<e.attributes.length;n++){var r=e.attributes[n];t.attr(r.name,r.value)}}function u(e,t){var n=$(e).get(0),r={},i=[];for(var s=0,o=n.attributes.length;s<o;s++)n.attributes[s].name.match(t)&&(r[n.attributes[s].name.replace(t,"")]=n.attributes[s].value,i.push(n.attributes[s].name));for(var u=0;u<i.length;u++)$(e).removeAttr(i[u]);return r}var t,n=window.Browser||e.Browser,r=e.Element,i=e.Queue,s=e.View;t=Class.extend({initialize:function(t,n,r){this._initialized=!1,this._parent=t||null,this._target=$(n),this.target=this._target,this._app=r,this._params={};if(!this._target||this._target.length===0&&typeof this.getDefaultView=="function")this._target=e.View.get(this.getDefaultView());this._source=this._target.outerHTML(),this._ignoreEvents=["load","appear","disappear","unload"],this._attrs=this.setupAttributes(),this._views=this.setupViews(),this._elems=this.setupElements(),this._loaded=!1,this._visible=!1,this._running=!1,this._loadEvts=[],this._unloadEvts=[],this._showEvts=[],this._hideEvts=[],this._queue=[],this.state,typeof this._target=="object"&&this._target.addClass("hidden"),this.setup(),this._initialized=!0},getDefaultRoute:function(){return null},getDefaultView:function(){return null},setRoute:function(e){var t=!1;if(!e||e.length===0)this.getDefaultRoute()?e=[this.getDefaultRoute()]:e=[];var n=e.slice(0),r=e.shift(),i=e.slice(0),s=this.state||this.getDefaultRoute(),o=this.getRoutes();if(Object.keys(o).length===0){for(var u in this.views)this.getView(u).setRoute(n.slice(0));return}o.hasOwnProperty(r)&&(console.log('Setting State: "/'+r+(s?'" from "'+s:"")+'" for "'+this.attr("name")+'"'),o[r].call(this,s,i)),this.state=r},getType:function(){return"view"},getBindings:function(){return{}},getRoutes:function(){return{}},setup:function(){},setModel:function(e,t){this._models||(this._models={}),this._models[e]=t},getModel:function(e){if(this._models.hasOwnProperty(e))return this._models[e];throw"Model Not Found"},add:function(e,t,n){return this._queue.push({fn:e,args:t,wait:n}),this._running||this.next(),this},next:function(){this._running=!0;var e=this._queue.shift();e?(e.fn.apply(this,e.args),e.wait&&e.wait>0&&(this._process=setTimeout(proxy(function(){this.next()},this),e.wait))):this._running=!1},stop:function(){return this._queue=[],this._process&&(clearTimeout(this._process),this.next()),this},addClass:function(){this._target.addClass.apply(this._target,arguments)},hasClass:function(){this._target.hasClass.apply(this._target,arguments)},removeClass:function(){this._target.removeClass.apply(this._target,arguments)},load:function(){return this.add(this._load)},show:function(){return this.add(this._show)},hide:function(){return this.add(this._hide)},unload:function(){return this.add(this._unload)},appendTo:function(e){return this.add(this._appendTo,[e])},append:function(e){return this.add(this._append,[e])},remove:function(){return this.add(this._remove)},run:function(e,t){return this.add(this._run,arguments)},_run:function(e,t,n){n?setTimeout(proxy(function(){e.call(t||this),this.next()},this),n):(e.call(t||this),this.next())},_load:function(){if(this._loaded){this.next();return}this._loadEvts.push(this.on("_load",this.onLoad,this)),this._loadEvts.push(this.on("_loaded",this.onDidLoad,this)),this.onWillLoad()},_show:function(){if(this._visible){this.next();return}if(!this._loaded)throw new Error("Invalid Request: Cannot show unloaded ViewController");this._showEvts.push(this.on("_appear",this.onAppear,this)),this._showEvts.push(this.on("_appeared",this.onDidAppear,this)),this.onWillAppear()},_hide:function(){if(!this._visible){this.next();return}this._hideEvts.push(this.on("_disappear",this.onDisappear,this)),this._hideEvts.push(this.on("_disappeared",this.onDidDisappear,this)),this.onWillDisappear()},_unload:function(){if(!this._loaded){this.next();return}if(this._visible)throw new Error("Invalid Request: Cannot unload visible ViewController");this._unloadEvts.push(this.on("_unload",this.onUnload,this)),this._unloadEvts.push(this.on("_unloaded",this.onDidUnload,this)),this.onWillUnload()},_appendTo:function(e){e instanceof t?e._target.append(this._target):e.append(this._target),this.next()},_append:function(e){e instanceof t?this._target.append(e._target):this._target.append(e),this.next()},_remove:function(){this._target.remove(),this.next()},onWillLoad:function(){this.fire("_load")},onLoad:function(){var e=Object.keys(this._views).length;if(e===0)this.fire("_loaded");else for(var t in this._views){var n=this._views[t];n.once("load",proxy(function(){e--,e===0&&this.fire("_loaded")},this)),n.load()}},onDidLoad:function(){this._loaded=!0;for(var e=0,t=this._loadEvts.length;e<t;e++)this._loadEvts[e].detach();this._loadEvts=[],this.fire("load"),this.next()},onWillUnload:function(){this.fire("_unload")},onUnload:function(){var e=Object.keys(this._views).length;if(e===0)this.fire("_unloaded");else for(var t in this._views){var n=this._views[t];n.once("unload",proxy(function(){e--,e===0&&this.fire("_unloaded")},this)),n.unload()}},onDidUnload:function(){this._loaded=!1;for(var e=0,t=this._unloadEvts.length;e<t;e++)this._unloadEvts[e].detach();this._unloadEvts=[],this.fire("unload"),this.next()},onWillAppear:function(){function s(e,r){var i=e.match(/^([#$\.A-Za-z0-9\-_]+)(?:\((.*)\))?/),s=i[1],o=i[2],u,a=n.touch?"touchend":"click";if(s==="$target")s=this._target;else if(s==="$body")s=$("body");else if(this.hasView(s))s=this.getView(s);else{if(!this.hasElement(s))return;s=this.getElement(s)}for(var f in r)f==="touchclick"?u=a:u=f,typeof r[f]=="function"&&(o&&s instanceof jQuery?s.on(u,o,proxy(r[f],this)):s instanceof t?s.on(u,r[f],this):s.on(u,proxy(r[f],this)))}var e=this.getBindings(),r,i;for(var o in e)s.call(this,o,e[o]);this._target.removeClass("hidden"),this.fire("_appear")},onAppear:function(e){var t=Object.keys(this._views).length;if(t===0)this.fire("_appeared");else for(var n in this._views){var r=this._views[n];r.once("appear",proxy(function(){t--,t===0&&this.fire("_appeared")},this)),r.show()}},onDidAppear:function(e){this._visible=!0;for(var t=0,n=this._showEvts.length;t<n;t++)this._showEvts[t].detach();this._showEvts=[],this.fire("appear"),this.next()},onWillDisappear:function(){for(var e in this._views)this.getView(e).detach();for(var t in this._elems)this.getElement(t).off();this.fire("_disappear")},onDisappear:function(e){var t=Object.keys(this._views).length;if(t===0)this.fire("_disappeared");else for(var n in this._views){var r=this._views[n];r.once("disappear",proxy(function(){t--,t===0&&this.fire("_disappeared")},this)),r.hide()}},onDidDisappear:function(e){this._target.addClass("hidden");for(var t=0,n=this._hideEvts.length;t<n;t++)this._hideEvts[t].detach();this._hideEvts=[],this._visible=!1,this.fire("disappear"),this.next()},attr:function(){var e=arguments;if(e.length===1)return this._attrs.hasOwnProperty(e[0])?this._attrs[e[0]]:!1;e.length===2&&(this._attrs[e[0]]=e[1])},find:function(){return this._target.find.apply(this._target,arguments)},getService:function(e){return this._app.getService(e)},getView:function(e){if(e instanceof t)return e;if(typeof this._views[e]!="undefined")return this._views[e];throw new Error('Invalid Request: View "'+e+'" not found')},getElement:function(e){if(typeof this._elems[e]!="undefined")return this._elems[e];throw new Error('Invalid Request: Element "'+e+'" not found')},hasView:function(e){return typeof this._views[e]!="undefined"},hasElement:function(e){return typeof this._elems[e]!="undefined"},addView:function(t,n,r,i,s){if(this.hasView(r))throw new Error("Invalid Request: ViewController "+r+" already exists");if(!t)throw"Invalid ViewController";var o=e.View.get(i,n,r);this._views[r]=new t(this,o,this._app),s==="body"?$("body").append(this._views[r]._target):s&&this._target.append(this._views[r]._target)},removeView:function(e){this.hasView(e)&&(this._views[e].hide().unload().destroy(),delete this._views[e])},setParam:function(e,t){this._params[e]=t},getParam:function(e){return this._params[e]},clearParam:function(e){delete this._params[e]},bindData:function(e,t,n){var r=e==="$target"?this._target:this.getElement(e),i=r.childrenTo("[itemprop]"),s;for(var o=0;o<i.length;o++)s=i[o].attr("itemprop"),s&&(i[o].get(0).tagName==="IMG"?t.hasOwnProperty(s)&&i[o].attr("src",t[s]):i[o].get(0).tagName==="SELECT"||i[o].get(0).tagName==="INPUT"?t.hasOwnProperty(s)&&i[o].val(""):t.hasOwnProperty(s)&&t[s]?i[o].text(t[s]):n||i[o].text(""))},goOnline:function(){for(var e in this._views)this._views[e].goOnline()},goOffline:function(){for(var e in this._views)this._views[e].goOffline()},setupAttributes:function(){if(this._initialized)return;var e=u(this._target,/data-/);return e.hasOwnProperty("name")||(e.name=e.control),this._target.addClass("view"),typeof this.typeList!="undefined"&&this._target.addClass(this.typeList),this._target.addClass(e.name),e},setupViews:function(){if(this._initialized)return;var n=this._target.childrenTo("[data-control]"),r={},i,s,u,a,f;for(var l=0;l<n.length;l++)s=n[l].attr("data-control"),i=n[l].attr("data-name"),a=n[l].attr("data-template"),a&&a.length>0&&(u=e.View.get(a,s,i),n[l].html(u.html()),o(u,n[l]),n[l].removeAttr("data-template")),i=i||s,f=t.get(s),r[i]=new f(this,n[l],this._app);return r},setupElements:function(){if(this._initialized)return;var e=this._target.childrenTo("[data-name]:not([data-control])"),t={},n;for(var r=0;r<e.length;r++)n=e[r].attr("data-name"),n.length>0&&(t[n]=e[r],e[r].removeAttr("data-name").addClass(n));return t},toString:function(){return"["+this.getType()+" "+this.attr("name")+"]"},destroy:function(){for(var e in this._views)this._views[e].destroy(),delete this._views[e];for(var t in this._elems)this._elems[t].destroy(),delete this._elems[t];delete this._views,delete this._elems,delete this._target,delete this._parent,delete this._source,delete this._queue}}).include(Events),t.views={view:t},t.extend=function(e){if(!e.hasOwnProperty("getType"))throw'Missing Implementation: ViewController missing "getType" implementation';var n=Class.extend.call(this,e),r=e.getType();if(t.views.hasOwnProperty(r))throw'Duplicate Class: ViewController "'+r+'" is already defined';return n.prototype.typeList?n.prototype.typeList+=" "+r:n.prototype.typeList=r,n.extend=t.extend,t.views[r]=n},t.get=function(e){if(this.views.hasOwnProperty(e))return this.views[e];throw'Invalid Resource: ViewController "'+e+'" not defined'},e.ViewController=t}(Clementine),function(e){var t=function(){function n(e,t,n){return $.ajax({async:n!==!0,contentType:"text/html; charset=utf-8",dataType:"text",timeout:1e4,url:"templates/"+e,success:function(n){t(e,n)},error:function(){throw"Error: template not found"}}).responseText}var e={},t={};return e.get=function(e,n,r){var i=this,s=[],o;if(!e||!t.hasOwnProperty(e))throw"Path "+e+" has not been loaded";$("<div>"+t[e]+"</div>").children().each(function(){s.push($(this))});for(var u=0;u<s.length;u++){if(typeof n!="undefined"&&s[u].attr("data-control")!==n)continue;if(typeof r!="undefined"&&s[u].attr("data-name")!==r)continue;return s[u].clone()}throw"Could not find view "+n+" at "+e},e.register=function(e,r){function o(e,n){t[e]=n,s--,s===0&&r()}var i,s=e.length;if(s===0)return r();for(var u=0;u<e.length;u++)i=e[u],n(e[u],proxy(o,this))},e}();e.View=t}(Clementine),function(e){var t=Class.extend({initialize:function(e){this.path=e},getType:function(){return"service"},getPrefix:function(){return""},_getPrefix:function(){if(!this.path)throw{type:"Configuration Error",message:"Missing base url"};return(this.path||"")+this.getPrefix()},request:function(e,t,n,r,i,s,o){if(!i||!s)throw{type:"Invalid Request",message:"Missing callback function"};r=r||function(e){return e},o=o||this,$.ajax({url:this._getPrefix()+e,type:t,timeout:6e4,data:n,success:function(e){if(e===null||e==="null"||e===!1||e==="false"){s.call(o);return}try{e=JSON.parse(e)}catch(t){s.call(o);return}var n;try{n=r.call(o,e)}catch(u){throw s.call(o,u),u}i.call(o,n)},error:function(){s.call(o,!0)}})},modelOrId:function(e){e&&typeof e=="object"&&e.hasOwnProperty("id")&&(e=e.id);if(!e)return;return e},destroy:function(){delete this.eventTarget}}).include(e.Events);t.services={service:t},t.extend=function(e){var n=Class.extend.call(this,e),r=e.getType(),i=["getType"];for(var s=0,o=i.length;s<o;s++){if(!e.hasOwnProperty(i[s]))throw"Class missing '"+i[s]+"()' implementation";n[i[s]]=e[i[s]]}return n.extend=arguments.callee,t.services[r]=n},t.get=function(e){if(e==="service")return this;if(!this.services.hasOwnProperty(e))throw"Service '"+e+'" not found';return this.services[e]},e.Service=t}(Clementine),function(e){function n(t){if(typeof e.modules[t]!==undefined)return e.modules[t];throw"Could not require module"}var t=function(){var t={},n={},r={};return e.modules={},{addModule:function(e,n,r){if(!e.match(/[\^\-A-Za-z_]/g))throw"Invalid module name";var i={name:e,fn:n,req:r!==undefined?r:[]};t[e]=i},loadModule:function(i){if(n.hasOwnProperty(i))return;if(t[i]!==undefined){n[i]=!0;for(var s=0,o=t[i].req.length;s<o;s++){if(t[i].req[s]===i)continue;this.loadModule(t[i].req[s])}t[i].fn.call(window,r),e.modules[i]=r}}}}();e.add=function(){var t=arguments,n=t[0],r=typeof t[1]=="function"?t[1]:null,i=t[2];e.Loader.addModule(n,r,i)},e.use=function(){var t=Array.prototype.slice.call(arguments),n=t[t.length-1],r=clone(t).splice(0,t.length-1);if(typeof r[0]!="function")for(var i=0,s=r.length;i<s;i++)e.Loader.loadModule(r[i]);n.call(window,e)},window.include=n,e.Loader=t}(Clementine),function(e){var t=Class.extend({initialize:function(t){if(!t.hasOwnProperty("name")||(new RegExp(/[^A-Za-z:0-9_\[\]]/g)).test(t.name))throw"Invalid Application Name";this.config=t,this.ready=!1,this.loaded=!1,this.config.name=t.name,this.config.required=t.hasOwnProperty("required")?t.required:[],this.config.services=t.hasOwnProperty("services")?t.services:[],this.config.views=t.hasOwnProperty("views")?t.views:[],this.config.paths=t.hasOwnProperty("paths")?t.paths:{},this.config.auth=t.hasOwnProperty("auth")?t.auth:null,this.env=t.env||"DEV";for(var n=0;n<this.config.required.length;n++)e.Loader.loadModule(this.config.required[n]);this.services={},this.config.auth?this.authenticate():this.loadServices(),$(document).ready(proxy(this.onReady,this))},getPath:function(){return this.config.paths[this.env]},authenticate:function(){var t=e.Service.get(this.config.auth);if(!this.config.paths.hasOwnProperty(this.env))throw"Invalid Service Path: Missing path for environment";var n=this.config.paths[this.env];this.services[this.config.auth]=new t(n),this.services[this.config.auth].on("token",this.onToken,this);var r=this.services[this.config.auth].getToken();r?(console.log("Token acquired: "+r),this.loadServices(r)):(console.log("Warning: Token not found: Services unauthenticated"),this.loadServices())},loadViews:function(){var t=this.config.views;if(t.length===0){this.onLoad();return}e.View.register(t,proxy(function(){this.onLoad()},this))},loadServices:function(t){var n=this.config.auth,r=this.config.services;if(r.length===0){this.loadViews();return}if(!this.config.paths.hasOwnProperty(this.env))throw"Invalid Service Path: Missing path for environment";var i=this.config.paths[this.env],s,o;for(var u=0;u<r.length;u++){if(n&&r[u]===n)continue;s=e.Service.get(r[u]),o=new s(i),t&&typeof o.getTokenService=="function"&&o.setToken(t),this.services[r[u]]=o,console.log("Service Loaded: '"+o.getType()+"'")}this.loadViews()},onToken:function(e){var t=this.config.auth;if(!e.data)return;var n=e.data;for(var r in this.services){if(r===t)continue;this.services[r].setToken(n)}console.log("Token acquired: "+n)},onReady:function(){this.ready=!0,this.loaded&&this.launch()},onLoad:function(){this.loaded=!0,this.ready&&this.launch()},launch:function(){var t=$("[data-root]"),n=t.attr("data-control"),r=t.attr("data-name")||n;if(!n||!r)throw"Syntax Error: Root view not found";t.removeAttr("data-root");var i=e.ViewController.get(n),t=new i(null,t,this);this.root=t,$(window).bind("hashchange",proxy(this.onHashChange,this)),t.on("load",function(){$(window).trigger("hashchange"),t.show()}),t.load(),console.log("Launching App: "+this.config.name)},onHashChange:function(){var e=location.hash;e?this.root.setRoute(e.replace("#","").split("/")):this.root.setRoute()},getService:function(e){return this.services[e]}});e.config=function(t){$(document).ready(function(){t&&(window.Application=new e.Application(t))})},e.Application=t}(Clementine)